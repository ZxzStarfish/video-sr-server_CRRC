# **video-sr-server_CRRC**

## ğŸ”é¡¹ç›®ç®€ä»‹
æœ¬æ¨¡å—æ˜¯"è½¨é“äº¤é€šè½¦è¾†æ™ºèƒ½è¿ç»´è¾¹äº‘ååŒç³»ç»Ÿ"ä¸­"è§†é¢‘ä¼ è¾“ä¼˜åŒ–å¹³å°æ¨¡å—"çš„æ ¸å¿ƒç»„ä»¶ï¼ŒåŸºäºæ·±åº¦å­¦ä¹ æ¨¡å‹ BasicVSR++ å®ç°ä½æ¸…è§†é¢‘çš„è¶…åˆ†è¾¨ç‡å¢å¼ºã€‚ä¸»è¦è§£å†³è½¦è½½è§†é¢‘å‹ç¼©ä¼ è¾“ååˆ†è¾¨ç‡ä¸‹é™ã€ç»†èŠ‚ç¼ºå¤±çš„é—®é¢˜ï¼Œé€šè¿‡ Ã—4 æ”¾å¤§ä¸è´¨é‡é‡å»ºï¼Œæå‡è§†é¢‘ PSNR æŒ‡æ ‡å’Œä¸»è§‚è§†è§‰æ•ˆæœï¼Œæ”¯æ’‘åç»­äººçœ¼å›é¡¾å’Œäº‹ä»¶åˆ†æç­‰åœºæ™¯ã€‚


## ğŸ› ï¸æŠ€æœ¯æ ˆ
- æ ¸å¿ƒæ¨¡å‹ï¼šBasicVSR++ï¼ˆåŸºäº MMagic æ¡†æ¶ï¼‰
- éƒ¨ç½²ç¯å¢ƒï¼šDocker + NVIDIA Orinï¼ˆARM64 æ¶æ„ï¼‰
- æ¥å£ç±»å‹ï¼šRESTful API
- æ”¯æŒæ ¼å¼ï¼šMP4 è§†é¢‘æ–‡ä»¶

## ğŸš€å¿«é€Ÿéƒ¨ç½²
### âš™ï¸ç¯å¢ƒä¾èµ–
- ç¡¬ä»¶ï¼šNVIDIA Orin å¹³å°ï¼ˆæ”¯æŒ GPU åŠ é€Ÿï¼‰
- è½¯ä»¶ï¼šDocker >= 20.10ï¼ŒNVIDIA Container Toolkit

### ğŸ‘£éƒ¨ç½²æ­¥éª¤
1. **éƒ¨ç½² Docker é•œåƒ**ï¼ˆé•œåƒå¤§å°çº¦ 7.9GBï¼‰
   åŸºç¡€é•œåƒ [dustynv/torchvision:0.21.0-r36.4.0-cu128](https://hub.docker.com/layers/dustynv/torchvision/0.21.0-r36.4.0-cu128)
   ```bash
   # ä»å‹ç¼©åŒ…åŠ è½½é•œåƒåˆ°æœ¬åœ°
   docker load -i video-sr-server:latest.tar.gz

   # æˆ–åœ¨ç›¸å…³ä»£ç ç›®å½•ï¼ˆvideoSR/10_09torchvisionï¼‰ä¸‹é‡æ–°æ„å»ºé•œåƒ
   # è¿è¡Œè¯¥æŒ‡ä»¤å‰ç¡®ä¿å½“å‰ç¯å¢ƒä¸­æœ‰é•œåƒdustynv/torchvision:0.21.0-r36.4.0-cu128
   sudo chmod +x build.sh
   sudo ./build.sh
   ```

3. **å¯åŠ¨æœåŠ¡å®¹å™¨**
   ```bash
   # æŒ‚è½½æ•°æ®ç›®å½•ï¼Œæ˜ å°„ç«¯å£ 6001ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
   sudo docker run -d --rm --gpus all \
     -p 6001:6001 \
     -v $(pwd)/data:/workspace/data \
     --name <å®¹å™¨å> \
     video-sr-server:latest python3 video_sr_server_withoutTime.py
   ```

4. **éªŒè¯æœåŠ¡çŠ¶æ€**
   ```bash
   # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
   docker ps | grep <å®¹å™¨å>

   # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   docker logs <å®¹å™¨å>
   ```

## ğŸ“‹ä½¿ç”¨æŒ‡å—
### ğŸ’»å‰ç«¯(ä¸åœ¨æœ¬é¡¹ç›®ä¸­å®ç°)åŠæ¥å£
| ä½¿ç”¨æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æ“ä½œå…¥å£ |
|----------|----------|----------|
| Web ç•Œé¢ | å¿«é€Ÿæµ‹è¯•ã€æ‰‹åŠ¨æ“ä½œã€ç”»è´¨å¯¹æ¯” | æµè§ˆå™¨è®¿é—® `http://<æœåŠ¡å™¨åœ°å€>:6001` |
| API æ¥å£ | ç³»ç»Ÿé›†æˆã€æ‰¹é‡å¤„ç†ã€è‡ªåŠ¨åŒ–æµç¨‹ | è°ƒç”¨ä¸‹æ–¹ RESTful API |


### ğŸ“¤API æ¥å£ä½¿ç”¨
#### æ¥å£è¯´æ˜ï¼ˆv3 ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨ï¼‰
> æ³¨ï¼šæ‰€æœ‰æ¥å£è¿”å›ç»“æœéœ€é€šè¿‡ã€ŒæŸ¥è¯¢ä»»åŠ¡è¿›åº¦æ¥å£ã€è·å–æœ€ç»ˆç»“æœ

##### 1. ä¸Šä¼ å•è§†é¢‘æ¥å£ï¼ˆupload_videoï¼‰
- URL: `http://<æœåŠ¡å™¨åœ°å€>:6001/api/upload_video`
- æ–¹æ³•: POST
- æè¿°: ä¸Šä¼ å•ä¸ª MP4 è§†é¢‘è¿›è¡Œè¶…åˆ†æ¨ç†
- è¯·æ±‚å‚æ•°ï¼š
  | å­—æ®µ        | ç±»å‹  | å¿…å¡« | è¯´æ˜                                  |
  |-------------|-------|------|---------------------------------------|
  | file        | file  | æ˜¯   | å¾…å¤„ç†çš„ MP4 è§†é¢‘æ–‡ä»¶                 |
  | max_seq_len | int   | å¦   | æ¨¡å‹æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆ10-50ï¼‰ï¼Œé»˜è®¤ 10    |
- è¿”å›ç¤ºä¾‹ï¼š
  ```json
  {
    "code": 200,
    "task_id": "a1b2c3d4-xxxx-xxxx-xxxx-xxxxxxxx",
    "message": "Upload successful, processing started"
  }
  ```

##### 2. ä¸Šä¼ å¯¹æ¯”è§†é¢‘æ¥å£ï¼ˆupload_video_displayï¼‰
- URL: `http://<æœåŠ¡å™¨åœ°å€>:6001/api/upload_video_display`
- æ–¹æ³•: POST
- æè¿°: ä¸Šä¼ ä½æ¸…è§†é¢‘å’Œé«˜æ¸…å‚è€ƒè§†é¢‘ï¼Œè¶…åˆ†åè®¡ç®— PSNR
- è¯·æ±‚å‚æ•°ï¼š
  | å­—æ®µ          | ç±»å‹  | å¿…å¡« | è¯´æ˜                                  |
  |---------------|-------|------|---------------------------------------|
  | low_res_video | file  | æ˜¯   | ä½åˆ†è¾¨ç‡è§†é¢‘ï¼ˆå¾…è¶…åˆ†ï¼‰                |
  | gt_video      | file  | æ˜¯   | é«˜åˆ†è¾¨ç‡å‚è€ƒè§†é¢‘ï¼ˆGround Truthï¼‰      |
  | max_seq_len   | int   | å¦   | æ¨¡å‹æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆ10-50ï¼‰ï¼Œé»˜è®¤ 10    |
- è¿”å›ç¤ºä¾‹ï¼š
  ```json
  {
    "code": 200,
    "task_id": "a1b2c3d4-xxxx-xxxx-xxxx-xxxxxxxx",
    "message": "Upload successful, processing started"
  }
  ```

##### 3. æŸ¥è¯¢ä»»åŠ¡è¿›åº¦æ¥å£ï¼ˆprogressï¼‰
- URL: `http://<æœåŠ¡å™¨åœ°å€>:6001/api/progress/<task_id>`
- æ–¹æ³•: GET
- æè¿°: è½®è¯¢ä»»åŠ¡è¿›åº¦ï¼Œä»»åŠ¡å®Œæˆåè¿”å›ç»“æœ
- è¯·æ±‚å‚æ•°ï¼š
  | å­—æ®µ    | ç±»å‹   | å¿…å¡« | è¯´æ˜                          |
  |---------|--------|------|-------------------------------|
  | task_id | string | æ˜¯   | ä¸Šä¼ æ¥å£è¿”å›çš„ä»»åŠ¡ ID         |
- è¿”å›ç¤ºä¾‹ï¼ˆä»»åŠ¡å®Œæˆï¼‰ï¼š
  ```json
  {
    "code": 200,
    "progress": 100,
    "status": "done",
    "result": {
      "file_url": "http://<æœåŠ¡å™¨åœ°å€>:6001/uploads/output/a1b2c3_output.mp4",
      "gt_video_info": {
        "size": 4711804,
        "duration": 4.5,
        "resolution": "1920x1080"
      },
      "low_res_video_info": {
        "size": 655559,
        "duration": 4.5,
        "resolution": "480x270"
      },
      "sr_video_info": {
        "size": 15098422,
        "duration": 4.32,
        "resolution": "1920x1080"
      },
      "low_res_psnr": 20.70,
      "sr_psnr": 22.02
    }
  }
  ```

##### 4. è·å–å¤„ç†åè§†é¢‘æ–‡ä»¶
- URL: `http://<æœåŠ¡å™¨åœ°å€>:6001/uploads/output/<filename>`
- æ–¹æ³•: GET
- æè¿°: é€šè¿‡æŸ¥è¯¢æ¥å£è¿”å›çš„ file_url ç›´æ¥ä¸‹è½½è§†é¢‘

### ğŸ§ªæµ‹è¯•å‘½ä»¤
#### 1. æµ‹è¯• API æ¥å£
```bash
# æµ‹è¯•å•ä¸ªè§†é¢‘è¶…åˆ† test_video_sr_api_all.py (allæŒ‡çš„æ˜¯è¿”å›çŠ¶æ€ç 200/400/500ç­‰æƒ…å†µ)
sudo docker exec -i <å®¹å™¨å> python3 < test_video_sr_api_all.py

# æµ‹è¯•å¯¹æ¯”è§†é¢‘è¶…åˆ† test_video_sr_api_display.py (displayè¡¨ç¤ºé’ˆå¯¹API2)
sudo docker exec -i <å®¹å™¨å> python3 < test_video_sr_api_display.py
```

#### 2. ç›´æ¥è¿è¡Œè¶…åˆ†è„šæœ¬ï¼ˆå®¹å™¨å†…ï¼‰
```bash
# è¿è¡Œè¶…åˆ†è„šæœ¬(è§†é¢‘æ–‡ä»¶è·¯å¾„ åº”é¢„å…ˆæŒ‚è½½/copyåˆ°å®¹å™¨é‡Œ)
sudo docker exec -i <å®¹å™¨å> python3 video_sr.py --input <è¾“å…¥è§†é¢‘æ–‡ä»¶è·¯å¾„> --output <è¾“å‡ºè§†é¢‘æ–‡ä»¶è·¯å¾„> --max_seq_len <å‚æ•°å€¼ï¼Œé»˜è®¤10>
```


## ğŸ“Œç‰ˆæœ¬è¯´æ˜
| ç‰ˆæœ¬ | ä¸»è¦å˜æ›´ |
|------|----------|
| v3ï¼ˆæœ€æ–°ï¼‰ | æ–°å¢ä»»åŠ¡è¿›åº¦æŸ¥è¯¢æ¥å£ï¼Œä¼˜åŒ–å¼‚æ­¥å¤„ç†æµç¨‹ |
| v2 | åŸºç¡€ API åŠŸèƒ½ï¼Œæ”¯æŒå•è§†é¢‘å’Œå¯¹æ¯”è§†é¢‘å¤„ç† |
